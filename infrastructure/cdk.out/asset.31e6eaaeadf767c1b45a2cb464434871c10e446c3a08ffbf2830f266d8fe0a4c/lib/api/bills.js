"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.billsService = exports.BillsService = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const utils_1 = require("./utils");
const logger_1 = require("../utils/logger");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.REGION });
const dynamoDB = lib_dynamodb_1.DynamoDBDocument.from(dynamoClient);
const s3Client = new client_s3_1.S3Client({ region: process.env.REGION });
const BILLS_TABLE = process.env.DYNAMODB_BILLS_TABLE;
const CACHE_BUCKET = process.env.S3_CACHE_BUCKET;
const CACHE_DURATION = 60 * 60; // 1 hour in seconds
const PARLIAMENT_API_URL = 'https://bills-api.parliament.uk/api/v1';
class BillsService {
    async getBills(params) {
        const cacheKey = `bills/${params.sessionId}/${params.page}/${params.limit}`;
        try {
            // Try S3 cache first
            const cachedData = await this.getFromCache(cacheKey);
            if (cachedData) {
                logger_1.logger.info('Cache hit - returning cached data');
                return cachedData;
            }
        }
        catch (err) {
            logger_1.logger.warn('Cache miss or error', { error: err });
        }
        // Try DynamoDB next
        try {
            const dynamoData = await this.getFromDynamo(params);
            if (dynamoData) {
                await this.setCache(cacheKey, dynamoData);
                return dynamoData;
            }
        }
        catch (err) {
            logger_1.logger.warn('DynamoDB error', { error: err });
        }
        // Finally, fetch from Parliament API
        try {
            const apiData = await this.fetchFromAPI(params);
            await Promise.all([
                this.setCache(cacheKey, apiData),
                this.storeBills(apiData.items)
            ]).catch(err => {
                logger_1.logger.error('Error storing fetched data', { error: err });
            });
            return apiData;
        }
        catch (err) {
            logger_1.logger.error('Error fetching from Parliament API', { error: err });
            throw err;
        }
    }
    async getFromCache(key) {
        try {
            const result = await s3Client.send(new client_s3_1.GetObjectCommand({
                Bucket: CACHE_BUCKET,
                Key: key
            }));
            const bodyContents = await result.Body?.transformToString();
            if (bodyContents) {
                const data = JSON.parse(bodyContents);
                if (Date.now() < data.expiresAt) {
                    return data.content;
                }
            }
        }
        catch (err) {
            logger_1.logger.debug('Cache miss', { error: err });
        }
        return null;
    }
    async setCache(key, data) {
        const cacheData = {
            content: data,
            expiresAt: Date.now() + (CACHE_DURATION * 1000)
        };
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: CACHE_BUCKET,
            Key: key,
            Body: JSON.stringify(cacheData),
            ContentType: 'application/json'
        }));
    }
    async getFromDynamo(params) {
        const { page = 1, limit = 20, sessionId = 58 } = params;
        try {
            const queryResult = await dynamoDB.send(new lib_dynamodb_1.QueryCommand({
                TableName: BILLS_TABLE,
                KeyConditionExpression: 'PK = :pk',
                ExpressionAttributeValues: {
                    ':pk': `SESSION#${sessionId}`
                },
                Limit: limit,
                ScanIndexForward: true
            }));
            if (!queryResult.Items || queryResult.Items.length === 0) {
                return null;
            }
            const bills = queryResult.Items.map((item) => ({
                billId: parseInt(item.SK.split('#')[1]),
                title: item.title,
                currentHouse: item.currentHouse,
                originatingHouse: item.originatingHouse,
                lastUpdate: item.lastUpdate,
                sessionId: item.sessionId,
                billTypeId: item.billTypeId,
                isDefeated: item.isDefeated,
                billWithdrawn: item.billWithdrawn
            }));
            return {
                items: bills,
                totalItems: queryResult.Count || 0,
                pageNumber: page,
                pageSize: limit,
                totalPages: Math.ceil((queryResult.Count || 0) / limit)
            };
        }
        catch (err) {
            logger_1.logger.error('DynamoDB query error', { error: err });
            return null;
        }
    }
    async storeBills(bills) {
        try {
            const putRequests = bills.map(bill => ({
                TableName: BILLS_TABLE,
                Item: this.mapBillToDynamoDB(bill)
            }));
            await Promise.all(putRequests.map(request => dynamoDB.send(new lib_dynamodb_1.PutCommand(request))));
        }
        catch (err) {
            logger_1.logger.error('Error storing bills in DynamoDB', { error: err });
        }
    }
    async fetchFromAPI(params) {
        const { page = 1, limit = 20, sessionId = 58 } = params;
        try {
            logger_1.logger.info('Fetching from Parliament API', { params });
            const data = await (0, utils_1.fetchWithRateLimit)(`${PARLIAMENT_API_URL}/Bills`, {
                params: {
                    take: limit,
                    skip: (page - 1) * limit,
                    SessionId: sessionId
                }
            });
            // Transform the API response to our Bill type
            const bills = data.items.map((item) => ({
                billId: item.billId,
                title: item.shortTitle,
                currentHouse: item.currentHouse,
                originatingHouse: item.originatingHouse,
                lastUpdate: item.lastUpdate,
                sessionId: item.sessionId,
                billTypeId: item.billTypeId,
                isDefeated: item.isDefeated,
                billWithdrawn: item.billWithdrawn
            }));
            return {
                items: bills,
                totalItems: data.totalResults,
                pageNumber: page,
                pageSize: limit,
                totalPages: Math.ceil(data.totalResults / limit)
            };
        }
        catch (err) {
            logger_1.logger.error('Error fetching from Parliament API', {
                error: err,
                params
            });
            throw new Error('Failed to fetch bills from Parliament API');
        }
    }
    mapBillToDynamoDB(bill) {
        return {
            PK: `SESSION#${bill.sessionId}`,
            SK: `BILL#${bill.billId}`,
            GSI1PK: `BILL_TYPE#${bill.billTypeId}`,
            GSI1SK: bill.lastUpdate,
            ...bill,
            ttl: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 days TTL
        };
    }
}
exports.BillsService = BillsService;
exports.billsService = new BillsService();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2FwaS9iaWxscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBMEQ7QUFDMUQsd0RBQW1GO0FBQ25GLGtEQUFrRjtBQUVsRixtQ0FBNkM7QUFDN0MsNENBQXlDO0FBRXpDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDeEUsTUFBTSxRQUFRLEdBQUcsK0JBQWdCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3JELE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFFOUQsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQztBQUNyRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztBQUNqRCxNQUFNLGNBQWMsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsb0JBQW9CO0FBQ3BELE1BQU0sa0JBQWtCLEdBQUcsd0NBQXdDLENBQUM7QUFFcEUsTUFBYSxZQUFZO0lBQ3ZCLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFJZDtRQUNDLE1BQU0sUUFBUSxHQUFHLFNBQVMsTUFBTSxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUU1RSxJQUFJLENBQUM7WUFDSCxxQkFBcUI7WUFDckIsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JELElBQUksVUFBVSxFQUFFLENBQUM7Z0JBQ2YsZUFBTSxDQUFDLElBQUksQ0FBQyxtQ0FBbUMs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TCxLQUFLLEVBQUUsS0FBSztnQkFDWixVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVk7Z0JBQzdCLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixRQUFRLEVBQUUsS0FBSztnQkFDZixVQUFVLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQzthQUNqRCxDQUFDO1FBQ0osQ0FBQztRQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDYixlQUFNLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFO2dCQUNqRCxLQUFLLEVBQUUsR0FBRztnQkFDVixNQUFNO2FBQ1AsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxJQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7SUFDSCxDQUFDO0lBRU8saUJBQWlCLENBQUMsSUFBVTtRQUNsQyxPQUFPO1lBQ0wsRUFBRSxFQUFFLFdBQVcsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUMvQixFQUFFLEVBQUUsUUFBUSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3pCLE1BQU0sRUFBRSxhQUFhLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDdEMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQ3ZCLEdBQUcsSUFBSTtZQUNQLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLGFBQWE7U0FDdEUsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTFNRCxvQ0EwTUM7QUFFWSxRQUFBLFlBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiXCI7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50LCBRdWVyeUNvbW1hbmQsIFB1dENvbW1hbmQgfSBmcm9tIFwiQGF3cy1zZGsvbGliLWR5bmFtb2RiXCI7XG5pbXBvcnQgeyBTM0NsaWVudCwgR2V0T2JqZWN0Q29tbWFuZCwgUHV0T2JqZWN0Q29tbWFuZCB9IGZyb20gXCJAYXdzLXNkay9jbGllbnQtczNcIjtcbmltcG9ydCB7IEJpbGwsIER5bmFtb0RCQmlsbCwgUGFnaW5hdGVkUmVzcG9uc2UgfSBmcm9tICcuLi90eXBlcy9wYXJsaWFtZW50JztcbmltcG9ydCB7IGZldGNoV2l0aFJhdGVMaW1pdCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5SRUdJT04gfSk7XG5jb25zdCBkeW5hbW9EQiA9IER5bmFtb0RCRG9jdW1lbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LlJFR0lPTiB9KTtcblxuY29uc3QgQklMTFNfVEFCTEUgPSBwcm9jZXNzLmVudi5EWU5BTU9EQl9CSUxMU19UQUJMRTtcbmNvbnN0IENBQ0hFX0JVQ0tFVCA9IHByb2Nlc3MuZW52LlMzX0NBQ0hFX0JVQ0tFVDtcbmNvbnN0IENBQ0hFX0RVUkFUSU9OID0gNjAgKiA2MDsgLy8gMSBob3VyIGluIHNlY29uZHNcbmNvbnN0IFBBUkxJQU1FTlRfQVBJX1VSTCA9ICdodHRwczovL2JpbGxzLWFwaS5wYXJsaWFtZW50LnVrL2FwaS92MSc7XG5cbmV4cG9ydCBjbGFzcyBCaWxsc1NlcnZpY2Uge1xuICBhc3luYyBnZXRCaWxscyhwYXJhbXM6IHtcbiAgICBwYWdlPzogbnVtYmVyO1xuICAgIGxpbWl0PzogbnVtYmVyO1xuICAgIHNlc3Npb25JZD86IG51bWJlcjtcbiAgfSk6IFByb21pc2U8UGFnaW5hdGVkUmVzcG9uc2U8QmlsbD4+IHtcbiAgICBjb25zdCBjYWNoZUtleSA9IGBiaWxscy8ke3BhcmFtcy5zZXNzaW9uSWR9LyR7cGFyYW1zLnBhZ2V9LyR7cGFyYW1zLmxpbWl0fWA7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIC8vIFRyeSBTMyBjYWNoZSBmaXJzdFxuICAgICAgY29uc3QgY2FjaGVkRGF0YSA9IGF3YWl0IHRoaXMuZ2V0RnJvbUNhY2hlKGNhY2hlS2V5KTtcbiAgICAgIGlmIChjYWNoZWREYXRhKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdDYWNoZSBoaXQgLSByZXR1cm5pbmcgY2FjaGVkIGRhdGEnKTtcbiAgICAgICAgcmV0dXJuIGNhY2hlZERhdGE7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybignQ2FjaGUgbWlzcyBvciBlcnJvcicsIHsgZXJyb3I6IGVyciB9KTtcbiAgICB9XG5cbiAgICAvLyBUcnkgRHluYW1vREIgbmV4dFxuICAgIHRyeSB7XG4gICAgICBjb25zdCBkeW5hbW9EYXRhID0gYXdhaXQgdGhpcy5nZXRGcm9tRHluYW1vKHBhcmFtcyk7XG4gICAgICBpZiAoZHluYW1vRGF0YSkge1xuICAgICAgICBhd2FpdCB0aGlzLnNldENhY2hlKGNhY2hlS2V5LCBkeW5hbW9EYXRhKTtcbiAgICAgICAgcmV0dXJuIGR5bmFtb0RhdGE7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybignRHluYW1vREIgZXJyb3InLCB7IGVycm9yOiBlcnIgfSk7XG4gICAgfVxuXG4gICAgLy8gRmluYWxseSwgZmV0Y2ggZnJvbSBQYXJsaWFtZW50IEFQSVxuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcGlEYXRhID0gYXdhaXQgdGhpcy5mZXRjaEZyb21BUEkocGFyYW1zKTtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgdGhpcy5zZXRDYWNoZShjYWNoZUtleSwgYXBpRGF0YSksXG4gICAgICAgIHRoaXMuc3RvcmVCaWxscyhhcGlEYXRhLml0ZW1zKVxuICAgICAgXSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvciBzdG9yaW5nIGZldGNoZWQgZGF0YScsIHsgZXJyb3I6IGVyciB9KTtcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICByZXR1cm4gYXBpRGF0YTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZmV0Y2hpbmcgZnJvbSBQYXJsaWFtZW50IEFQSScsIHsgZXJyb3I6IGVyciB9KTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEZyb21DYWNoZShrZXk6IHN0cmluZyk6IFByb21pc2U8UGFnaW5hdGVkUmVzcG9uc2U8QmlsbD4gfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHMzQ2xpZW50LnNlbmQobmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IENBQ0hFX0JVQ0tFVCxcbiAgICAgICAgS2V5OiBrZXlcbiAgICAgIH0pKTtcbiAgICAgIFxuICAgICAgY29uc3QgYm9keUNvbnRlbnRzID0gYXdhaXQgcmVzdWx0LkJvZHk/LnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gICAgICBpZiAoYm9keUNvbnRlbnRzKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGJvZHlDb250ZW50cyk7XG4gICAgICAgIGlmIChEYXRlLm5vdygpIDwgZGF0YS5leHBpcmVzQXQpIHtcbiAgICAgICAgICByZXR1cm4gZGF0YS5jb250ZW50O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NhY2hlIG1pc3MnLCB7IGVycm9yOiBlcnIgfSk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZXRDYWNoZShrZXk6IHN0cmluZywgZGF0YTogUGFnaW5hdGVkUmVzcG9uc2U8QmlsbD4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjYWNoZURhdGEgPSB7XG4gICAgICBjb250ZW50OiBkYXRhLFxuICAgICAgZXhwaXJlc0F0OiBEYXRlLm5vdygpICsgKENBQ0hFX0RVUkFUSU9OICogMTAwMClcbiAgICB9O1xuXG4gICAgYXdhaXQgczNDbGllbnQuc2VuZChuZXcgUHV0T2JqZWN0Q29tbWFuZCh7XG4gICAgICBCdWNrZXQ6IENBQ0hFX0JVQ0tFVCxcbiAgICAgIEtleToga2V5LFxuICAgICAgQm9keTogSlNPTi5zdHJpbmdpZnkoY2FjaGVEYXRhKSxcbiAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbidcbiAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEZyb21EeW5hbW8ocGFyYW1zOiB7XG4gICAgcGFnZT86IG51bWJlcjtcbiAgICBsaW1pdD86IG51bWJlcjtcbiAgICBzZXNzaW9uSWQ/OiBudW1iZXI7XG4gIH0pOiBQcm9taXNlPFBhZ2luYXRlZFJlc3BvbnNlPEJpbGw+IHwgbnVsbD4ge1xuICAgIGNvbnN0IHsgcGFnZSA9IDEsIGxpbWl0ID0gMjAsIHNlc3Npb25JZCA9IDU4IH0gPSBwYXJhbXM7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcXVlcnlSZXN1bHQgPSBhd2FpdCBkeW5hbW9EQi5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IEJJTExTX1RBQkxFLFxuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnUEsgPSA6cGsnLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzpwayc6IGBTRVNTSU9OIyR7c2Vzc2lvbklkfWBcbiAgICAgICAgfSxcbiAgICAgICAgTGltaXQ6IGxpbWl0LFxuICAgICAgICBTY2FuSW5kZXhGb3J3YXJkOiB0cnVlXG4gICAgICB9KSk7XG5cbiAgICAgIGlmICghcXVlcnlSZXN1bHQuSXRlbXMgfHwgcXVlcnlSZXN1bHQuSXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBiaWxscyA9IHF1ZXJ5UmVzdWx0Lkl0ZW1zLm1hcCgoaXRlbTogUmVjb3JkPHN0cmluZywgYW55PikgPT4gKHtcbiAgICAgICAgYmlsbElkOiBwYXJzZUludChpdGVtLlNLLnNwbGl0KCcjJylbMV0pLFxuICAgICAgICB0aXRsZTogaXRlbS50aXRsZSxcbiAgICAgICAgY3VycmVudEhvdXNlOiBpdGVtLmN1cnJlbnRIb3VzZSxcbiAgICAgICAgb3JpZ2luYXRpbmdIb3VzZTogaXRlbS5vcmlnaW5hdGluZ0hvdXNlLFxuICAgICAgICBsYXN0VXBkYXRlOiBpdGVtLmxhc3RVcGRhdGUsXG4gICAgICAgIHNlc3Npb25JZDogaXRlbS5zZXNzaW9uSWQsXG4gICAgICAgIGJpbGxUeXBlSWQ6IGl0ZW0uYmlsbFR5cGVJZCxcbiAgICAgICAgaXNEZWZlYXRlZDogaXRlbS5pc0RlZmVhdGVkLFxuICAgICAgICBiaWxsV2l0aGRyYXduOiBpdGVtLmJpbGxXaXRoZHJhd25cbiAgICAgIH0pKTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXRlbXM6IGJpbGxzLFxuICAgICAgICB0b3RhbEl0ZW1zOiBxdWVyeVJlc3VsdC5Db3VudCB8fCAwLFxuICAgICAgICBwYWdlTnVtYmVyOiBwYWdlLFxuICAgICAgICBwYWdlU2l6ZTogbGltaXQsXG4gICAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbCgocXVlcnlSZXN1bHQuQ291bnQgfHwgMCkgLyBsaW1pdClcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0R5bmFtb0RCIHF1ZXJ5IGVycm9yJywgeyBlcnJvcjogZXJyIH0pO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzdG9yZUJpbGxzKGJpbGxzOiBCaWxsW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcHV0UmVxdWVzdHMgPSBiaWxscy5tYXAoYmlsbCA9PiAoe1xuICAgICAgICBUYWJsZU5hbWU6IEJJTExTX1RBQkxFLFxuICAgICAgICBJdGVtOiB0aGlzLm1hcEJpbGxUb0R5bmFtb0RCKGJpbGwpXG4gICAgICB9KSk7XG5cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBwdXRSZXF1ZXN0cy5tYXAocmVxdWVzdCA9PiBkeW5hbW9EQi5zZW5kKG5ldyBQdXRDb21tYW5kKHJlcXVlc3QpKSlcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0Vycm9yIHN0b3JpbmcgYmlsbHMgaW4gRHluYW1vREInLCB7IGVycm9yOiBlcnIgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmZXRjaEZyb21BUEkocGFyYW1zOiB7XG4gICAgcGFnZT86IG51bWJlcjtcbiAgICBsaW1pdD86IG51bWJlcjtcbiAgICBzZXNzaW9uSWQ/OiBudW1iZXI7XG4gIH0pOiBQcm9taXNlPFBhZ2luYXRlZFJlc3BvbnNlPEJpbGw+PiB7XG4gICAgY29uc3QgeyBwYWdlID0gMSwgbGltaXQgPSAyMCwgc2Vzc2lvbklkID0gNTggfSA9IHBhcmFtcztcbiAgICBcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmluZm8oJ0ZldGNoaW5nIGZyb20gUGFybGlhbWVudCBBUEknLCB7IHBhcmFtcyB9KTtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmZXRjaFdpdGhSYXRlTGltaXQ8YW55PihcbiAgICAgICAgYCR7UEFSTElBTUVOVF9BUElfVVJMfS9CaWxsc2AsXG4gICAgICAgIHtcbiAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgIHRha2U6IGxpbWl0LFxuICAgICAgICAgICAgc2tpcDogKHBhZ2UgLSAxKSAqIGxpbWl0LFxuICAgICAgICAgICAgU2Vzc2lvbklkOiBzZXNzaW9uSWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBcbiAgICAgIC8vIFRyYW5zZm9ybSB0aGUgQVBJIHJlc3BvbnNlIHRvIG91ciBCaWxsIHR5cGVcbiAgICAgIGNvbnN0IGJpbGxzOiBCaWxsW10gPSBkYXRhLml0ZW1zLm1hcCgoaXRlbTogYW55KSA9PiAoe1xuICAgICAgICBiaWxsSWQ6IGl0ZW0uYmlsbElkLFxuICAgICAgICB0aXRsZTogaXRlbS5zaG9ydFRpdGxlLFxuICAgICAgICBjdXJyZW50SG91c2U6IGl0ZW0uY3VycmVudEhvdXNlLFxuICAgICAgICBvcmlnaW5hdGluZ0hvdXNlOiBpdGVtLm9yaWdpbmF0aW5nSG91c2UsXG4gICAgICAgIGxhc3RVcGRhdGU6IGl0ZW0ubGFzdFVwZGF0ZSxcbiAgICAgICAgc2Vzc2lvbklkOiBpdGVtLnNlc3Npb25JZCxcbiAgICAgICAgYmlsbFR5cGVJZDogaXRlbS5iaWxsVHlwZUlkLFxuICAgICAgICBpc0RlZmVhdGVkOiBpdGVtLmlzRGVmZWF0ZWQsXG4gICAgICAgIGJpbGxXaXRoZHJhd246IGl0ZW0uYmlsbFdpdGhkcmF3blxuICAgICAgfSkpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBpdGVtczogYmlsbHMsXG4gICAgICAgIHRvdGFsSXRlbXM6IGRhdGEudG90YWxSZXN1bHRzLFxuICAgICAgICBwYWdlTnVtYmVyOiBwYWdlLFxuICAgICAgICBwYWdlU2l6ZTogbGltaXQsXG4gICAgICAgIHRvdGFsUGFnZXM6IE1hdGguY2VpbChkYXRhLnRvdGFsUmVzdWx0cyAvIGxpbWl0KVxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgZmV0Y2hpbmcgZnJvbSBQYXJsaWFtZW50IEFQSScsIHsgXG4gICAgICAgIGVycm9yOiBlcnIsXG4gICAgICAgIHBhcmFtcyBcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggYmlsbHMgZnJvbSBQYXJsaWFtZW50IEFQSScpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbWFwQmlsbFRvRHluYW1vREIoYmlsbDogQmlsbCk6IER5bmFtb0RCQmlsbCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFBLOiBgU0VTU0lPTiMke2JpbGwuc2Vzc2lvbklkfWAsXG4gICAgICBTSzogYEJJTEwjJHtiaWxsLmJpbGxJZH1gLFxuICAgICAgR1NJMVBLOiBgQklMTF9UWVBFIyR7YmlsbC5iaWxsVHlwZUlkfWAsXG4gICAgICBHU0kxU0s6IGJpbGwubGFzdFVwZGF0ZSxcbiAgICAgIC4uLmJpbGwsXG4gICAgICB0dGw6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApICsgKDcgKiAyNCAqIDYwICogNjApIC8vIDcgZGF5cyBUVExcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBiaWxsc1NlcnZpY2UgPSBuZXcgQmlsbHNTZXJ2aWNlKCk7Il19